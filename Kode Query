SELECT 
    t.tahun,
    t.skenario,
    SUM(t.pendapatan) AS pendapatan,
    SUM(t.beban_operasional) AS beban_operasional,
    SUM(t.penyusutan) AS penyusutan,
    SUM(t.pendapatan - (t.beban_operasional + t.penyusutan)) AS laba_kotor,
    SUM(t.pendapatan - (t.beban_operasional + t.penyusutan)) AS laba_operasional,
    k.tax_rate,
    CASE 
        WHEN t.tahun BETWEEN k.tax_holiday_awal AND k.tax_holiday_akhir AND t.skenario = 'tax_holiday' 
        THEN 0
        ELSE SUM(t.pendapatan - (t.beban_operasional + t.penyusutan)) * k.tax_rate
    END AS pph_badan,
    CASE 
        WHEN t.tahun BETWEEN k.tax_holiday_awal AND k.tax_holiday_akhir AND t.skenario = 'tax_holiday' 
        THEN SUM(t.pendapatan - (t.beban_operasional + t.penyusutan))
        ELSE SUM(t.pendapatan - (t.beban_operasional + t.penyusutan)) * (1 - k.tax_rate)
    END AS laba_bersih
FROM decoded-tribute-461406-n8.PPh_Badan.transaksi_keuangan t
JOIN decoded-tribute-461406-n8.PPh_Badan.kebijakan_fiskal k
ON t.tahun = k.tahun
GROUP BY t.tahun, t.skenario, k.tax_rate, k.tax_holiday_awal, k.tax_holiday_akhir
ORDER BY t.tahun, t.skenario;

WITH DepresiasiGarisLurus AS (
    SELECT
        aset_id,
        kategori,
        nilai_perolehan,
        umur_ekonomis,
        nilai_perolehan / umur_ekonomis AS depresiasi_tahunan,
        'garis_lurus' AS metode
    FROM decoded-tribute-461406-n8.PPh_Badan.aset_tetap
    WHERE metode = 'garis_lurus'
),
DepresiasiSaldoMenurun AS (
    SELECT
        aset_id,
        kategori,
        nilai_perolehan,
        umur_ekonomis,
        ROUND(2 * (nilai_perolehan / umur_ekonomis), 2) AS depresiasi_tahunan,
        'saldo_menurun_berganda' AS metode
    FROM decoded-tribute-461406-n8.PPh_Badan.aset_tetap
    WHERE metode = 'saldo_menurun'
)
SELECT * FROM DepresiasiGarisLurus
UNION ALL
SELECT * FROM DepresiasiSaldoMenurun
ORDER BY aset_id;

SELECT 
    t.tahun,
    t.skenario,
    SUM(t.pendapatan - (t.beban_operasional + t.penyusutan)) AS laba_operasional,
    CASE 
        WHEN t.tahun BETWEEN k.tax_holiday_awal AND k.tax_holiday_akhir AND t.skenario = 'tax_holiday' 
        THEN 0
        ELSE SUM(t.pendapatan - (t.beban_operasional + t.penyusutan)) * k.tax_rate
    END AS pph_badan,
    CASE 
        WHEN t.tahun BETWEEN k.tax_holiday_awal AND k.tax_holiday_akhir AND t.skenario = 'tax_holiday' 
        THEN SUM(t.pendapatan - (t.beban_operasional + t.penyusutan))
        ELSE SUM(t.pendapatan - (t.beban_operasional + t.penyusutan)) * (1 - k.tax_rate)
    END AS arus_kas_setelah_pajak
FROM decoded-tribute-461406-n8.PPh_Badan.transaksi_keuangan t
JOIN decoded-tribute-461406-n8.PPh_Badan.kebijakan_fiskal k
ON t.tahun = k.tahun
WHERE t.skenario IN ('normal', 'tax_holiday')
GROUP BY t.tahun, t.skenario, k.tax_rate, k.tax_holiday_awal, k.tax_holiday_akhir
ORDER BY t.tahun, t.skenario;
